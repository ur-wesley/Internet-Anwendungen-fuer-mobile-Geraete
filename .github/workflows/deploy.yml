name: Build and Deploy to GitHub Pages

on:
 workflow_dispatch:
 push:
  branches: [main]
 pull_request:
  branches: [main]

permissions:
 contents: read
 pages: write
 id-token: write

concurrency:
 group: "pages"
 cancel-in-progress: false

jobs:
 build:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout
     uses: actions/checkout@v4

   - name: Setup Bun
     uses: oven-sh/setup-bun@v1
     with:
      bun-version: latest

   - name: Install dependencies
     run: bun install

   - name: Create public/data directory
     run: mkdir -p public/data

   - name: Fetch album charts
     run: bun scripts/fetchAlbumCharts.ts

   - name: Build project
     run: bun run build

   - name: Setup Pages
     uses: actions/configure-pages@v4

   - name: Upload artifact
     uses: actions/upload-pages-artifact@v3
     with:
      path: "./dist"

 deploy:
  environment:
   name: github-pages
   url: ${{ steps.deployment.outputs.page_url }}
  runs-on: ubuntu-latest
  needs: build
  steps:
   - name: Deploy to GitHub Pages
     id: deployment
     uses: actions/deploy-pages@v4
